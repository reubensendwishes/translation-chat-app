let isRefreshing = false
let failedQueue: any[] = []

const processQueue = (error: any, token: string | null = null) => {
	failedQueue.forEach(prom => {
		if (error) {
			prom.reject(error)
		} else {
			prom.resolve(token)
		}
	})
	isRefreshing = false
	failedQueue = []
}

axios.interceptors.response.use(
	(response) => response,
	async (error) => {
		const originalRequest = error.config

		if (error.response?.status === 401 && !originalRequest._retry) {
			if (isRefreshing) {
				// 已經在刷新，加入隊列等待
				return new Promise((resolve, reject) => {
					failedQueue.push({ resolve, reject })
				}).then(token => {
					originalRequest.headers['Authorization'] = `Bearer ${token}`
					return axios(originalRequest)
				})
			}

			originalRequest._retry = true
			isRefreshing = true

			const { refreshAccessToken } = useAuth()
			const success = await refreshAccessToken()

			if (success) {
				processQueue(null, authStore.accessToken)
				return axios(originalRequest)
			} else {
				processQueue(new Error('刷新失敗'), null)
				return Promise.reject(error)
			}
		}

		return Promise.reject(error)
	}
)